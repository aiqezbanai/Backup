<!-- version 16 -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>AI QEZ BACKUP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fade-in-scale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s forwards;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Constants ---
        const INITIAL_ROLES = {
          USER: {
            name: 'User',
            passHash: '34d60c167db86fa9b328c3085d5edc5b011597b05e405f2c8173ffb9ac8e2dc8df4e8347ac74a27692bd92dff1e8c3c5a5ab1acf6b761a093f62f74e2aaea986', // user123
            storageLimit: '10 GB',
            folderLimit: '5',
            permissions: 'import, edit, move, delete',
            dashboardAccess: []
          },
          MODERATOR: {
            name: 'Moderator',
            passHash: 'd29372d813a3d0e8350b72ca7996c1d517bfdb41f43afd11d9ed07cab1cad28a3f9663a94ef5e32a489fae104086e7a4d1250ee68ebd58797ab3b9eab0476f4f', // moderator123
            storageLimit: '128 GB',
            folderLimit: '10',
            permissions: 'import, edit, move, delete, manage_folders',
            dashboardAccess: ['panel', 'files', 'folders']
          },
          ADMIN: {
            name: 'Administrator',
            passHash: '4bafc43a0b8a798f0ef61553a70bbd0747800aa1daeb08043607d950d6f1d99ed5f4aff589fc9e9a32dbd6ca2e0860e22036293908a1d869f7a7be29d36dcdf1', // admin123
            storageLimit: '16 TB',
            folderLimit: 'Unlimited',
            permissions: 'import, edit, move, delete, manage_folders, maintenance, admin_panel_full_access',
            dashboardAccess: ['panel', 'content', 'files', 'formats', 'folders', 'settings']
          }
        };
        const INITIAL_MAINTENANCE_HTML = `<div class="fixed inset-0 bg-gray-900 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop');"><div class="absolute inset-0 bg-black bg-opacity-60"></div><div class="relative text-white flex flex-col items-center justify-center h-screen text-center p-4"> <h1 class="text-5xl font-bold mb-4">Under Maintenance</h1><p class="text-xl">We will be back shortly. Thank you for your patience.</p></div></div>`;
        const INITIAL_MAINTENANCE_CSS = `body { margin: 0; font-family: 'Inter', sans-serif; }`;
        const INITIAL_MAINTENANCE_JS = `console.log("Maintenance mode active.");`;
        const DELETE_PASSWORD_HASH = '1f1f1d24a5c53b15425a1656b8e83363297a7ebb2a38626601f2f05a2f5752c2864197c36a644955b405c935104445c0a3ccb5f0e03a9f02375908b079730f59'; // Delete!
        const TOTAL_STORAGE_BYTES = 16 * 1024 * 1024 * 1024 * 1024; // 16 TB
        const ITEMS_PER_PAGE = 10;
        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes
        const INITIAL_SUPPORTED_FILE_FORMATS = [
            '.txt', '.json', '.xml', '.csv', '.vbk', '.vib', '.bff', '.zip', '.tar', '.gz', '.gzip', '.sql', '.dump', '.bkp', '.backup', '.daf', '.7z', '.rar', '.bak', '.docx', '.xlsx', '.pptx', '.svg', '.mp3', '.html', '.php', '.css','.js', '.py', '.pgsql', '.png', '.jpg', '.mp4', '.jpeg', '.mpeg', '.wav', '.pdf', '.db',
        ];
        
        // --- Services & Hooks ---
        const hashString = (input) => CryptoJS.SHA512(input).toString(CryptoJS.enc.Hex);
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);
        
        const formatBytes = (bytes, decimals = 2) => {
            if (!isFinite(bytes) || bytes === Infinity) return 'Unlimited';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        const parseLimit = (limitStr) => {
            if (typeof limitStr === 'number') return limitStr;
            if (typeof limitStr !== 'string') return 0;
            if (limitStr.toLowerCase() === 'unlimited') return Infinity;

            const parts = limitStr.split(' ');
            const value = parseFloat(parts[0]);
            if (isNaN(value)) return 0;
            const unit = (parts[1] || '').toUpperCase();
            const units = { 'BYTES': 1, 'KB': 1024, 'MB': 1024**2, 'GB': 1024**3, 'TB': 1024**4, 'PB': 1024**5 };
            return value * (units[unit] || 1);
        };
        
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { console.error(error); return initialValue; }
            });
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) { console.error(error); }
            };
            return [storedValue, setValue];
        }

        // --- UI Icons ---
        const ICONS = {
            Dashboard: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            Content: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            Files: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>,
            Formats: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 21h7a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v11m0 5l4.879-4.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242z" /></svg>,
            Folders: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Logout: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Delete: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>,
            Edit: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.293a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>,
            Move: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L9 5.414V17a1 1 0 102 0V5.414l5.293 5.293a1 1 0 001.414-1.414l-7-7z" /></svg>,
            Folder: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor" {...props}><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>,
            Back: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor" {...props}><path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" /></svg>,
            Copy: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.124-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.124-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            UserActive: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /><circle cx="19" cy="19" r="2.5" fill="rgb(34 197 94)" stroke="rgb(17 24 39)" strokeWidth="1" /></svg>,
            Disk: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" {...props}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 3a2 2 0 012-2h6a2 2 0 012 2v2a1 1 0 102 0V3a4 4 0 00-4-4H7a4 4 0 00-4 4v10a4 4 0 004 4h6a4 4 0 004-4v-2a1 1 0 10-2 0v2a2 2 0 01-2 2H7a2 2 0 01-2-2V3z" /></svg>,
            Connect: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2} {...props}><path strokeLinecap="round" strokeLinejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.536a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>,
            Refresh: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" {...props}><path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" /></svg>,
            GitHub: (props) => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>,
            AwsS3: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12.4,14.5l-2,3.5c-0.2,0.3-0.5,0.5-0.9,0.5c-0.2,0-0.4-0.1-0.6-0.2L2.3,15.1c-0.5-0.3-0.7-0.9-0.4-1.4l2-3.5 C4.2,9.7,4.8,9.5,5.3,9.8l1.4,0.8L9,5.9c0.2-0.3,0.5-0.5,0.9-0.5h4.4c0.4,0,0.7,0.2,0.9,0.5l2.2,4.8l1.4-0.8 c0.5-0.3,1.1-0.1,1.4,0.4l2,3.5c0.3,0.5,0.1,1.1-0.4,1.4l-6.6,3.8c-0.2,0.1-0.4,0.2-0.6,0.2C12.9,18.5,12.6,18.3,12.4,18 L10.1,14l1.3-2.3L12.4,14.5z M6.1,12.8l-1.2,2.1l5.2,3l1.2-2.1L6.1,12.8z M12.1,6.8L10.4,10l3.4,1.9L15.9,7l-1.2-2.6h-2.1 L12.1,6.8z M13.3,12.8L12,15.1l5.2,3l1.2-2.1L13.3,12.8z"/></svg>,
            Firebase: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M6.3,13.5l-2.4,4.2C3.7,18.1,3.9,18.7,4.3,19l0,0l4.3-2.5L6.3,13.5z M17.7,13.5L12,17.2V3.8l3.4,5.9l2.4-4.2 c0.2-0.4,0.8-0.5,1.1-0.2l0,0c0.4,0.2,0.5,0.8,0.2,1.1L17.7,13.5z M8.6,16.5L4.3,19c-0.4,0.2-0.9,0-1.1-0.4l0,0 c-0.2-0.4,0-0.9,0.4-1.1l8.5-5L8.6,16.5z"/></svg>,
            Dropbox: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M6,4.5l6,4l-6,4L6,4.5z M12,8.5l6,4l-6,4l-6-4L12,8.5z M12,15.5l-6,4h12L12,15.5z M18,4.5l-6,4l6,4L18,4.5z"/></svg>,
            GoogleAi: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12.5,2.3c0.4-0.4,0.4-1,0-1.4c-0.4-0.4-1-0.4-1.4,0L9,3.1L6.9,0.9C6.5,0.6,6,0.6,5.6,0.9L3.5,3.1L1.4,0.9 C1-0.3,0.4-0.3,0,0.9c-0.4,0.4-0.4,1,0,1.4l2.1,2.1L0,6.7c-0.4,0.4-0.4,1,0,1.4l2.1,2.1L0,12.5c-0.4,0.4-0.4,1,0,1.4l2.1,2.1 L0,18.2c-0.4,0.4-0.4,1,0,1.4L5.6,23c0.4,0.4,1,0.4,1.4,0l2.1-2.1l2.1,2.1c0.4,0.4,1,0.4,1.4,0l6.7-6.7c0.4-0.4,0.4-1,0-1.4 L17,12.8l2.1-2.1c0.4-0.4,0.4-1,0-1.4l-2.1-2.1L19.2,5c0.4-0.4,0.4-1,0-1.4L12.5,2.3z M11.8,11.8L10.4,13l-4.2-4.2l1.4-1.4 L11.8,11.8z"/></svg>,
            ChatGpt: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M18.8,12.1c-0.4-0.4-1-0.4-1.4,0c-0.4,0.4-0.4,1,0,1.4l0.7,0.7c-1.3,1.3-3,2.2-4.9,2.4v-2.3c0.6-0.2,1-0.8,1-1.4 c0-0.8-0.7-1.5-1.5-1.5s-1.5,0.7-1.5,1.5c0,0.7,0.4,1.2,1,1.4v2.3c-1.9-0.2-3.6-1-4.9-2.4l0.7-0.7c0.4-0.4,0.4-1,0-1.4 c-0.4-0.4-1-0.4-1.4,0L4.3,13.5c-1.8-3.2-1.8-7,0-10.1l1.4,1.4c0.4,0.4,1,0.4,1.4,0c0.4-0.4,0.4-1,0-1.4L5.7,2.1 C8.8-0.7,13.6-0.7,16.7,2.1l-1.4,1.4c-0.4,0.4-0.4,1,0,1.4c0.4,0.4,1,0.4,1.4,0l1.4-1.4c3.2,3.2,3.2,7,0,10.1L18.8,12.1z"/></svg>,
            Claude: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M12,20c-4.4,0-8-3.6-8-8s3.6-8,8-8s8,3.6,8,8 S16.4,20,12,20z M12,9c-1.7,0-3,1.3-3,3s1.3,3,3,3s3-1.3,3-3S13.7,9,12,9z"/></svg>,
            PostgreSql: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M10,18H8v-6h2V18z M12,18h-1v-1.5c0-1.4,0.8-2.5,2-2.5 s2,1.1,2,2.5V18h-1v-1.5c0-0.8-0.7-1.5-1-1.5s-1,0.7-1,1.5V18z M16,18h-2v-6h2V18z"/></svg>,
            MongoDb: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10c5.2,0,9.5-4,10-9h-4c-0.6,2.8-3,5-5.9,5s-5.4-2.2-5.9-5H2c0.5,5,4.8,9,10,9 s9.5-4,10-9V3c-0.5-0.6-1.1-1.1-1.8-1.5C18,2.2,15.1,3.4,12,3.4S6,2.2,3.8,1.5C4.5,1.1,5.1,0.6,5.8,0C5.3,0.6,5,1.3,5,2 c0,3.9,3.1,7,7,7s7-3.1,7-7c0-0.7-0.1-1.4-0.4-2C16.9,0.5,14.7,1,12,1S7.1,0.5,5.8,0z"/></svg>,
            Supabase: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M16,18h-2.5l-3-4H10v4H8V6h5c2.2,0,4,1.8,4,4 c0,1.8-1.2,3.3-2.8,3.8L16,18z M13.5,8H10v2h3.5c1.1,0,2-0.9,2-2S14.6,8,13.5,8z"/></svg>,
            N8n: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6" {...props}><path d="M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M10,16l-3-3l1.4-1.4L10,13.2l4.6-4.6L16,10L10,16z"/></svg>,
        };
        
        // --- Shared Components ---
        const Notification = ({ message, type = 'success', show }) => {
          const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
          return (
            <div className={`fixed bottom-5 right-5 p-4 rounded-lg shadow-lg text-white ${bgColor} transition-transform duration-500 ease-in-out z-[100] ${show ? 'translate-x-0' : 'translate-x-[calc(100%+20px)]'}`}>
              {message}
            </div>
          );
        };

        const BUTTON_CLASSES = {
            logout: "bg-red-600 hover:bg-red-700 text-gray-200",
            exit: "bg-red-600 hover:bg-red-700 text-gray-200",
            login: "bg-blue-600 hover:bg-blue-700 text-gray-200",
            delete: "bg-red-600 hover:bg-red-700 text-gray-200",
            create: "bg-blue-600 hover:bg-blue-700 text-gray-200",
            edit: "bg-yellow-500 hover:bg-yellow-600 text-gray-200",
            update: "bg-green-600 hover:bg-green-700 text-gray-200",
            save: "bg-green-600 hover:bg-green-700 text-gray-200",
            download: "bg-green-600 hover:bg-green-700 text-gray-200",
            disable: "bg-red-600 hover:bg-red-700 text-gray-200",
            enable: "bg-green-600 hover:bg-green-700 text-gray-200",
            cancel: "bg-gray-600 hover:bg-gray-700 text-gray-200",
            connect: "bg-indigo-600 hover:bg-indigo-700 text-gray-200",
            refresh: "bg-gray-500 hover:bg-gray-600 text-white",
            default: "bg-gray-500 hover:bg-gray-600 text-white",
        };

        const AppButton = ({ onClick, children, variant = 'default', type = 'button', disabled = false, className = '' }) => (
            <button
                type={type}
                onClick={onClick}
                disabled={disabled}
                className={`flex items-center justify-center gap-2 font-bold py-2 px-4 rounded-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed ${BUTTON_CLASSES[variant] || BUTTON_CLASSES.default} ${className}`}
            >
                {children}
            </button>
        );

        const GeneralModal = ({ children, onClose, title }) => {
            useEffect(() => {
                const handleEsc = (event) => { if (event.key === 'Escape') onClose(); };
                window.addEventListener('keydown', handleEsc);
                return () => window.removeEventListener('keydown', handleEsc);
            }, [onClose]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300" onClick={onClose}>
                    <div className="bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 w-11/12 max-w-md transform transition-all duration-300 scale-95 opacity-0 animate-fade-in-scale" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-2xl font-bold text-white mb-4">{title}</h2>
                        {children}
                    </div>
                </div>
            );
        };

        const PasswordPromptModal = ({ action, onClose, onSubmit, error, title, description, confirmText }) => {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(password); };

            return (
                <GeneralModal title={title} onClose={onClose}>
                    <p className="text-gray-400 mb-6">{description}</p>
                    <form onSubmit={handleSubmit}>
                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200 mb-4 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="••••••••••••" autoFocus />
                        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                        <div className="flex justify-end space-x-4">
                            <AppButton type="button" onClick={onClose} variant="cancel">Cancel</AppButton>
                            <AppButton type="submit" variant={action === 'login' ? 'login' : 'delete'}>{confirmText}</AppButton>
                        </div>
                    </form>
                </GeneralModal>
            );
        };
        
        const IntegrationModal = ({ serviceName, integration, onUpdate, onClose, showNotification }) => {
            const [apiKey, setApiKey] = useState(integration?.apiKey || '');
            const serviceIcons = {
                'AWS S3 API': <ICONS.AwsS3 className="text-white h-8 w-8" />,
                'Firebase API': <ICONS.Firebase className="text-white h-8 w-8" />,
                'Dropbox API': <ICONS.Dropbox className="text-white h-8 w-8" />,
                'Google AI Studio': <ICONS.GoogleAi className="text-white h-8 w-8" />,
                'ChatGPT': <ICONS.ChatGpt className="text-white h-8 w-8" />,
                'Claude': <ICONS.Claude className="text-white h-8 w-8" />,
                'PostgreSQL API': <ICONS.PostgreSql className="text-white h-8 w-8" />,
                'MongoDB Atlas API': <ICONS.MongoDb className="text-white h-8 w-8" />,
                'Supabase API': <ICONS.Supabase className="text-white h-8 w-8" />,
                'n8n Webhook': <ICONS.N8n className="text-white h-8 w-8" />,
                'GitHub API': <ICONS.GitHub className="text-white h-8 w-8" />,
            };

            const handleEnable = () => {
                if (!apiKey.trim()) {
                    showNotification('API Key cannot be empty to enable.', 'error');
                    return;
                }
                onUpdate(serviceName, apiKey, true);
                showNotification(`${serviceName} enabled.`, 'success');
                onClose();
            };

            const handleDisable = () => {
                onUpdate(serviceName, apiKey, false);
                showNotification(`${serviceName} disabled.`, 'success');
                onClose();
            };

            const handleDelete = () => {
                onUpdate(serviceName, '', false);
                showNotification(`${serviceName} configuration deleted.`, 'success');
                onClose();
            };
            
            return (
                <GeneralModal title={`Manage ${serviceName}`} onClose={onClose}>
                    <div className="flex items-center gap-4 mb-6">
                        {serviceIcons[serviceName]}
                        <p className="text-gray-300 text-lg font-semibold">{serviceName}</p>
                    </div>
                    <p className="text-gray-400 mb-4">Enter the API Key or Webhook URL below.</p>
                    <input
                        type="text"
                        value={apiKey}
                        onChange={(e) => setApiKey(e.target.value)}
                        placeholder="Enter API Key here"
                        className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200 mb-6 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    />
                    <div className="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-4">
                        <AppButton onClick={handleDelete} variant="delete">Delete</AppButton>
                        <AppButton onClick={handleDisable} variant="disable" disabled={!integration?.enabled}>Disable</AppButton>
                        <AppButton onClick={handleEnable} variant="enable">Enable</AppButton>
                    </div>
                </GeneralModal>
            );
        };

        const ConfirmActionModal = ({ title, message, onConfirm, onCancel, confirmVariant, confirmText }) => {
             return (
                 <GeneralModal title={title} onClose={onCancel}>
                     <p className="text-gray-400 mb-6">{message}</p>
                     <div className="flex justify-end space-x-4">
                         <AppButton onClick={onCancel} variant="cancel">Cancel</AppButton>
                         <AppButton onClick={onConfirm} variant={confirmVariant}>{confirmText}</AppButton>
                     </div>
                 </GeneralModal>
             );
        };

        const ContextMenu = ({ x, y, items, onClose }) => {
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        onClose();
                    }
                };
                const handleEsc = (event) => {
                    if (event.key === 'Escape') {
                        onClose();
                    }
                };

                document.addEventListener("mousedown", handleClickOutside);
                document.addEventListener("keydown", handleEsc);
                return () => {
                    document.removeEventListener("mousedown", handleClickOutside);
                    document.removeEventListener("keydown", handleEsc);
                };
            }, [onClose]);
            
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const menuWidth = 192;
            const menuHeight = items.length * 40;
            const finalX = (x + menuWidth > screenWidth) ? screenWidth - menuWidth - 5 : x;
            const finalY = (y + menuHeight > screenHeight) ? screenHeight - menuHeight - 5 : y;
            const menuStyle = { top: `${finalY}px`, left: `${finalX}px` };
            
            return (
                <div
                    ref={menuRef}
                    className="absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-2xl py-1 w-48 animate-fade-in-scale"
                    style={menuStyle}
                >
                    <ul className="divide-y divide-gray-700">
                    {items.map((item, index) => (
                        <li key={index}>
                            <button
                                onClick={() => { item.onClick(); onClose(); }}
                                className="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-700/50 flex items-center gap-3 transition-colors duration-150"
                            >
                                <span className="w-5 h-5 text-gray-400">{item.icon}</span>
                                <span>{item.label}</span>
                            </button>
                        </li>
                    ))}
                    </ul>
                </div>
            );
        };
        
        const Pagination = ({ currentPage, totalPages, onPageChange }) => {
            if (totalPages <= 1) return null;
            return (
                <div className="flex justify-center items-center mt-6 space-x-4">
                    <AppButton onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1}>Previous</AppButton>
                    <span className="text-gray-400">Page {currentPage} of {totalPages}</span>
                    <AppButton onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages}>Next</AppButton>
                </div>
            );
        };

        const AddRoleModal = ({ roles, setRoles, onClose, showNotification }) => {
            const [roleName, setRoleName] = useState('');
            const [password, setPassword] = useState('');
            
            const handleAddRole = (e) => {
                e.preventDefault();
                const roleKey = roleName.toUpperCase().replace(/\s+/g, '_');
                if (!roleName.trim() || !password.trim()) {
                    showNotification('Role Name and Password cannot be empty.', 'error');
                    return;
                }
                if (roles[roleKey]) {
                    showNotification('A role with this name already exists.', 'error');
                    return;
                }

                const newRole = {
                    name: roleName,
                    passHash: hashString(password),
                    storageLimit: '1 GB',
                    folderLimit: '5',
                    permissions: 'import, edit, move, delete',
                    dashboardAccess: [],
                };

                setRoles(prev => ({ ...prev, [roleKey]: newRole }));
                showNotification(`Role '${roleName}' created successfully.`, 'success');
                onClose();
            };

            return (
                <GeneralModal title="Add New Role" onClose={onClose}>
                    <form onSubmit={handleAddRole} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-1">Role Name</label>
                            <input
                                type="text"
                                value={roleName}
                                onChange={(e) => setRoleName(e.target.value)}
                                className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                placeholder="e.g., Content Editor"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-300 mb-1">Password</label>
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                placeholder="••••••••••••"
                            />
                        </div>
                        <div className="flex justify-end space-x-4 pt-4">
                            <AppButton type="button" onClick={onClose} variant="cancel">Cancel</AppButton>
                            <AppButton type="submit" variant="create">Add Role</AppButton>
                        </div>
                    </form>
                </GeneralModal>
            );
        };
        
        // --- User File Management Dashboard Components ---
        const Header = ({ currentUser, roles, onLoginClick, onLogoutClick }) => (
            <header className="bg-gray-800 shadow-md sticky top-0 z-20">
                <div className="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
                    <h1 className="text-xl md:text-3xl font-bold text-white tracking-wider">AI QEZ BACKUP</h1>
                    {currentUser ? (
                        <div className="flex items-center gap-4">
                            <span className="text-gray-300 hidden sm:block">Role: {roles[currentUser].name}</span>
                            <AppButton onClick={onLogoutClick} variant="exit">Exit</AppButton>
                        </div>
                    ) : (
                        <AppButton onClick={onLoginClick} variant="login">Login</AppButton>
                    )}
                </div>
            </header>
        );

        const StorageInfo = ({ used, total }) => {
            const usedPercent = total > 0 && isFinite(total) ? (used / total) * 100 : 0;
            return (
                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <div className="flex justify-between items-center mb-2 text-sm text-gray-400">
                        <span>Used: {formatBytes(used)}</span>
                        <span>Total: {formatBytes(total)}</span>
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div className="bg-blue-600 h-4 rounded-full transition-all duration-500 ease-out" style={{ width: `${usedPercent}%` }}></div>
                    </div>
                </div>
            );
        };
        
        const BackupTable = ({ backups, onAction, currentPage, itemsPerPage, hasPermission }) => {
            return (
                 <div className="overflow-x-auto">
                    <table className="min-w-full bg-gray-800 text-sm text-left text-gray-300">
                        <thead className="bg-gray-700 text-xs uppercase">
                            <tr>
                                <th scope="col" className="px-6 py-3 w-12">#</th>
                                <th scope="col" className="px-6 py-3">Name</th>
                                <th scope="col" className="px-6 py-3 hidden md:table-cell">Date</th>
                                <th scope="col" className="px-6 py-3 hidden lg:table-cell">Time</th>
                                <th scope="col" className="px-6 py-3 hidden md:table-cell">Size</th>
                                <th scope="col" className="px-6 py-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {backups.length > 0 ? backups.map((backup, index) => (
                                <tr key={backup.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                    <td className="px-6 py-4 font-medium text-gray-400">{(currentPage - 1) * itemsPerPage + index + 1}</td>
                                    <td className="px-6 py-4 font-medium text-white whitespace-nowrap">{backup.name}</td>
                                    <td className="px-6 py-4 hidden md:table-cell">{backup.date}</td>
                                    <td className="px-6 py-4 hidden lg:table-cell">{backup.time}</td>
                                    <td className="px-6 py-4 hidden md:table-cell">{formatBytes(backup.size)}</td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center justify-center space-x-2">
                                            <button onClick={() => { /* Implement export */ }} title="Export" className="text-blue-400 hover:text-blue-300"><ICONS.Download /></button>
                                            {hasPermission('edit') && <button onClick={() => onAction('edit_file', backup)} title="Edit" className="text-yellow-400 hover:text-yellow-300"><ICONS.Edit /></button>}
                                            {hasPermission('move') && <button onClick={() => onAction('move_file', backup)} title="Move" className="text-green-400 hover:text-green-300"><ICONS.Move /></button>}
                                            {hasPermission('delete') && <button onClick={() => onAction('confirm_password_delete', { itemType: 'user_file', itemId: backup.id, itemName: backup.name })} title="Delete" className="text-red-500 hover:text-red-400"><ICONS.Delete /></button>}
                                        </div>
                                    </td>
                                </tr>
                            )) : (
                                <tr><td colSpan={6} className="text-center py-8 text-gray-500">No files in this folder.</td></tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };
        
        const FolderView = ({ folders, backups, onFolderCreate, onFolderSelect, onShowRoot, onAction, hasPermission }) => {
            const [newFolderName, setNewFolderName] = useState('');
            const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, selectedFolder: null });
            
            const fileCounts = useMemo(() => {
                const counts = {};
                backups.forEach(backup => {
                    if(backup.folderId){
                        counts[backup.folderId] = (counts[backup.folderId] || 0) + 1;
                    }
                });
                return counts;
            }, [backups]);

            const handleCreate = () => {
                if (newFolderName.trim()) {
                    onFolderCreate(newFolderName.trim());
                    setNewFolderName('');
                }
            };
            
            const handleContextMenu = (event, folder) => {
                event.preventDefault();
                event.stopPropagation();
                if (hasPermission('manage_folders')) {
                    setContextMenu({ show: true, x: event.pageX, y: event.pageY, selectedFolder: folder });
                }
            };

            const closeContextMenu = useCallback(() => {
                setContextMenu(prev => ({ ...prev, show: false }));
            }, []);

            const contextMenuItems = contextMenu.selectedFolder && hasPermission('manage_folders') ? [
                { label: 'Edit', icon: <ICONS.Edit />, onClick: () => onAction('edit_folder', contextMenu.selectedFolder) },
                { label: 'Copy', icon: <ICONS.Copy />, onClick: () => onAction('copy_folder', contextMenu.selectedFolder) },
                { label: 'Delete', icon: <ICONS.Delete />, onClick: () => onAction('confirm_password_delete', {itemType: 'user_folder', itemId: contextMenu.selectedFolder.id, itemName: contextMenu.selectedFolder.name}) },
            ] : [];

            return (
                <div className="mt-8 bg-gray-800 shadow-lg rounded-lg p-4 md:p-6">
                    <h2 className="text-xl font-bold text-white mb-4">Folders</h2>
                    {hasPermission('manage_folders') && (
                        <div className="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" value={newFolderName} onChange={(e) => setNewFolderName(e.target.value)} placeholder="New folder name" className="flex-grow bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            <AppButton onClick={handleCreate} variant="create"><ICONS.Plus /> Create</AppButton>
                        </div>
                    )}
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <button onClick={onShowRoot} className="flex flex-col items-center justify-center p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition text-center group">
                            <ICONS.Back /> <span className="mt-1 text-sm">Root</span>
                        </button>
                        {folders.map(folder => (
                            <div key={folder.id} onContextMenu={(e) => handleContextMenu(e, folder)} className="relative bg-gray-700 rounded-lg group">
                               <button 
                                 onClick={() => onFolderSelect(folder.id, folder.name)} 
                                 className="w-full h-full flex flex-col items-center justify-center p-4 hover:bg-gray-600 rounded-lg transition text-center"
                               >
                                   <ICONS.Folder /> <span className="mt-1 text-sm break-all">{folder.name}</span>
                               </button>
                               {(fileCounts[folder.id] > 0) && (
                                 <div className="absolute top-1 right-1 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center pointer-events-none">
                                    {fileCounts[folder.id]}
                                 </div>
                               )}
                            </div>
                        ))}
                    </div>
                    {contextMenu.show && <ContextMenu x={contextMenu.x} y={contextMenu.y} items={contextMenuItems} onClose={closeContextMenu} />}
                </div>
            );
        };

        const UserFileDashboard = ({ currentUser, roles, backups, folders, supportedFormats, showNotification, openLoginModal, onLogout, openModal, onAction }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [currentFolder, setCurrentFolder] = useState({ id: null, name: 'Root' });
            
            const fileInputRef = useRef(null);
            
            const userRole = useMemo(() => currentUser ? roles[currentUser] : null, [currentUser, roles]);
            const userRoleLimits = useMemo(() => {
                if (!userRole) return { limit: 0, folderLimit: 0, permissions: [] };
                return {
                    limit: parseLimit(userRole.storageLimit),
                    folderLimit: userRole.folderLimit.toLowerCase() === 'unlimited' ? Infinity : parseInt(userRole.folderLimit, 10),
                    permissions: userRole.permissions.split(',').map(p => p.trim())
                }
            }, [userRole]);
            
            const hasPermission = useCallback((perm) => userRoleLimits.permissions.includes(perm), [userRoleLimits]);

            const userBackups = useMemo(() => backups.filter(b => b.owner === currentUser), [backups, currentUser]);
            const userFolders = useMemo(() => folders.filter(f => f.owner === currentUser), [folders, currentUser]);

            const filteredAndSortedItems = useMemo(() => {
                const filesInCurrent = userBackups
                    .filter(b => (b.folderId || null) === currentFolder.id)
                    .filter(b => b.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .sort((a,b) => a.name.localeCompare(b.name));

                return { files: filesInCurrent };
            }, [userBackups, currentFolder.id, searchTerm]);
            
            const paginatedBackups = useMemo(() => {
                const newTotalPages = Math.ceil(filteredAndSortedItems.files.length / ITEMS_PER_PAGE);
                if (currentPage > newTotalPages && newTotalPages > 0) {
                    setCurrentPage(1);
                }
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                return filteredAndSortedItems.files.slice(startIndex, startIndex + ITEMS_PER_PAGE);
            }, [filteredAndSortedItems.files, currentPage]);
            
            const totalPages = Math.ceil(filteredAndSortedItems.files.length / ITEMS_PER_PAGE);
            const usedStorage = useMemo(() => userBackups.reduce((acc, b) => acc + b.size, 0), [userBackups]);
            
            const handleFileImport = (e) => {
                const files = e.target.files ? Array.from(e.target.files) : [];
                if (!files.length) return;
                
                let newBackups = [];
                let currentTotalSize = usedStorage;
                let errors = [];

                files.forEach(file => {
                    const fileExtension = '.' + file.name.split('.').pop();
                    if (!supportedFormats.includes(fileExtension.toLowerCase())) {
                        errors.push(`File type '${fileExtension}' is not supported for "${file.name}".`);
                        return;
                    }
                    if (currentTotalSize + file.size > userRoleLimits.limit) {
                        errors.push(`Not enough storage for "${file.name}".`);
                        return;
                    }
                    
                    const now = new Date();
                    newBackups.push({
                        name: file.name, size: file.size,
                        date: now.toLocaleDateString(), time: now.toLocaleTimeString(),
                        owner: currentUser, folderId: currentFolder.id,
                    });
                    currentTotalSize += file.size;
                });
                
                if (newBackups.length > 0) {
                    onAction('import_files', newBackups);
                    showNotification(`${newBackups.length} file(s) imported successfully.`, 'success');
                }
                if (errors.length > 0) {
                    showNotification(errors.join(' '), 'error');
                }
                e.target.value = '';
            };
            
            const handleCreateFolder = (name) => {
                 if (userRoleLimits.folderLimit !== Infinity && userFolders.length >= userRoleLimits.folderLimit) {
                    showNotification(`Folder limit (${userRoleLimits.folderLimit}) reached.`, 'error');
                    return;
                }
                if (userFolders.some(f => f.name.toLowerCase() === name.toLowerCase() && (f.folderId || null) === currentFolder.id)) {
                    showNotification(`A folder named '${name}' already exists here.`, 'error');
                    return;
                }
                onAction('create_folder', { name, folderId: currentFolder.id });
            };

            return (
                <div className="min-h-screen bg-gray-900 text-gray-200 font-sans">
                    <Header currentUser={currentUser} roles={roles} onLoginClick={openLoginModal} onLogoutClick={onLogout} />
                    <main className="container mx-auto p-4 md:p-8">
                        {currentUser ? (
                            <>
                                <StorageInfo used={usedStorage} total={userRoleLimits.limit} />
                                <FolderView 
                                  folders={userFolders.filter(f => (f.folderId || null) === currentFolder.id)} 
                                  backups={userBackups}
                                  onFolderCreate={handleCreateFolder}
                                  onFolderSelect={(id, name) => {setCurrentFolder({id, name}); setCurrentPage(1);}}
                                  onShowRoot={() => {setCurrentFolder({id: null, name: 'Root'}); setCurrentPage(1);}}
                                  onAction={openModal}
                                  hasPermission={hasPermission}
                                />
                                <div className="mt-8 bg-gray-800 shadow-lg rounded-lg p-4 md:p-6">
                                    <div className="flex flex-wrap justify-between items-center mb-4 gap-4">
                                        <h2 className="text-xl font-bold text-white w-full md:w-auto text-center md:text-left">
                                          Files in {currentFolder.name}
                                        </h2>
                                        <input type="text" placeholder="Search files..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full md:w-1/3 bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200" />
                                        {hasPermission('import') && 
                                            <>
                                                <AppButton onClick={() => fileInputRef.current?.click()} variant="create" className="w-full md:w-auto"><ICONS.Plus/> Import File</AppButton>
                                                <input type="file" ref={fileInputRef} className="hidden" multiple onChange={handleFileImport}/>
                                            </>
                                        }
                                    </div>
                                    <BackupTable backups={paginatedBackups} onAction={openModal} currentPage={currentPage} itemsPerPage={ITEMS_PER_PAGE} hasPermission={hasPermission} />
                                    <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                                </div>
                            </>
                        ) : (
                            <div className="text-center py-20">
                                <h2 className="text-3xl font-bold text-white mb-4">Welcome to AI QEZ BACKUP</h2>
                                <p className="text-gray-400 text-lg">Please log in to manage your files.</p>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // --- Admin Dashboard Components ---
        const AdminSidebar = ({ activePage, setActivePage, onLogout, isMobileMenuOpen, setMobileMenuOpen, accessiblePages }) => {
            const menuItems = [
                { id: 'panel', label: 'Panel', icon: <ICONS.Dashboard /> },
                { id: 'content', label: 'Content', icon: <ICONS.Content /> },
                { id: 'files', label: 'Files', icon: <ICONS.Files /> },
                { id: 'formats', label: 'Formats', icon: <ICONS.Formats /> },
                { id: 'folders', label: 'Folders', icon: <ICONS.Folders /> },
                { id: 'settings', label: 'Settings', icon: <ICONS.Settings /> },
            ];

            const visibleItems = menuItems.filter(item => accessiblePages.includes(item.id));

            return (
                <aside className={`fixed lg:relative inset-y-0 left-0 w-64 bg-gray-800 shadow-md transform lg:transform-none transition-transform duration-300 z-40 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                    <div className="flex flex-col h-full">
                        <div className="p-4 border-b border-gray-700 flex justify-between items-center lg:justify-center">
                            <h1 className="text-2xl font-bold text-white">Admin Panel</h1>
                            <button onClick={() => setMobileMenuOpen(false)} className="lg:hidden text-white"><ICONS.Menu /></button>
                        </div>
                        <nav className="flex-1 p-2 space-y-2">
                            {visibleItems.map(item => (
                                <button key={item.id} onClick={() => { setActivePage(item.id); if(isMobileMenuOpen) setMobileMenuOpen(false); }}
                                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-md text-lg transition-colors ${activePage === item.id ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700'}`}>
                                    {item.icon}<span>{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-gray-700">
                             <AppButton onClick={onLogout} variant="exit" className="w-full flex items-center justify-center gap-2">
                                <ICONS.Logout /> Exit
                            </AppButton>
                        </div>
                    </div>
                </aside>
            );
        };
        
        const StatCard = ({ title, value, subtext, icon }) => (
            <div className="bg-gray-800 p-6 rounded-lg shadow-lg flex items-center justify-between">
                <div>
                    <p className="text-sm text-gray-400">{title}</p>
                    <p className="text-3xl font-bold">{value}</p>
                    <p className="text-xs text-gray-500">{subtext}</p>
                </div>
                <div className="bg-gray-700 p-3 rounded-full">{icon}</div>
            </div>
        );

        const DashboardPanelPage = ({ backups, roles, currentUser }) => {
            const usedStorage = useMemo(() => backups.reduce((acc, file) => acc + file.size, 0), [backups]);
            const totalUsers = Object.keys(roles).length;
            const activeUsers = currentUser ? 1 : 0; // Simplified for this client-side context

            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Dashboard</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <StatCard title="Total Storage" value={formatBytes(TOTAL_STORAGE_BYTES)} subtext="Total System Capacity" icon={<ICONS.Disk />} />
                        <StatCard title="Used Storage" value={formatBytes(usedStorage)} subtext={`${((usedStorage / TOTAL_STORAGE_BYTES) * 100).toFixed(2)}% of total capacity`} icon={<ICONS.Disk />} />
                        <StatCard title="Total User Roles" value={totalUsers} subtext="All configured roles" icon={<ICONS.Users />} />
                        <StatCard title="Active User Sessions" value={activeUsers} subtext="Currently logged in" icon={<ICONS.UserActive />} />
                    </div>
                </div>
            );
        };

        const DashboardContentPage = ({ showNotification }) => {
            const [code, setCode] = useLocalStorage('maintenance_html', INITIAL_MAINTENANCE_HTML);
            const [tempCode, setTempCode] = useState(code);
            const handleSave = () => {
                setCode(tempCode);
                showNotification('Maintenance page content updated.', 'success');
            };
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Maintenance Page Content</h2>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <p className="text-gray-400 mb-4">Edit the HTML content for the maintenance page. This will be shown to non-admin users when maintenance mode is active.</p>
                        <textarea value={tempCode} onChange={(e) => setTempCode(e.target.value)} rows={15} className="w-full bg-gray-900 border border-gray-700 rounded-md p-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none custom-scrollbar"></textarea>
                        <div className="flex justify-end mt-4">
                            <AppButton onClick={handleSave} variant="save">Save Content</AppButton>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardFilesPage = ({ backups, roles, openModal }) => {
            const handleFileDelete = (file) => {
                openModal('confirm_password_delete', { 
                    itemType: 'admin_file', 
                    itemId: file.id,
                    itemName: file.name
                });
            };
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">All Files</h2>
                    <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-gray-800 text-sm text-left text-gray-300">
                                <thead className="bg-gray-700 text-xs uppercase">
                                    <tr>
                                        <th scope="col" className="px-6 py-3">Name</th>
                                        <th scope="col" className="px-6 py-3">Owner</th>
                                        <th scope="col" className="px-6 py-3">Size</th>
                                        <th scope="col" className="px-6 py-3">Date</th>
                                        <th scope="col" className="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {backups.map(backup => (
                                        <tr key={backup.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                            <td className="px-6 py-4 font-medium text-white">{backup.name}</td>
                                            <td className="px-6 py-4">{roles[backup.owner]?.name || 'Unknown'}</td>
                                            <td className="px-6 py-4">{formatBytes(backup.size)}</td>
                                            <td className="px-6 py-4">{backup.date} {backup.time}</td>
                                            <td className="px-6 py-4 text-center">
                                                <button onClick={() => handleFileDelete(backup)} title="Delete" className="text-red-500 hover:text-red-400"><ICONS.Delete /></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {backups.length === 0 && (
                                        <tr><td colSpan="5" className="text-center py-8 text-gray-500">No files in the system.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const DashboardFormatsPage = ({ supportedFormats, setSupportedFormats, showNotification, openModal }) => {
            const [newFormat, setNewFormat] = useState('');
            const handleAdd = () => {
                if(newFormat && !newFormat.startsWith('.')) {
                    showNotification('Format must start with a dot "."', 'error');
                    return;
                }
                if (newFormat && !supportedFormats.includes(newFormat)) {
                    setSupportedFormats([...supportedFormats, newFormat.toLowerCase()]);
                    setNewFormat('');
                    showNotification(`Format '${newFormat}' added.`, 'success');
                } else {
                    showNotification('Format is empty or already exists.', 'error');
                }
            };
             const handleRemove = (formatToRemove) => {
                openModal('confirm_password_delete', { 
                    itemType: 'format', 
                    itemId: formatToRemove,
                    itemName: formatToRemove
                });
            };

            return (
                 <div>
                    <h2 className="text-3xl font-bold mb-6">Supported File Formats</h2>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div className="flex gap-4 mb-6">
                            <input type="text" value={newFormat} onChange={e => setNewFormat(e.target.value)} placeholder=".example" className="flex-grow bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-gray-200"/>
                            <AppButton onClick={handleAdd} variant="create">Add Format</AppButton>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {supportedFormats.sort().map(format => (
                                <div key={format} className="bg-gray-700 p-3 rounded-md flex justify-between items-center">
                                    <span className="font-mono text-white">{format}</span>
                                    <button onClick={() => handleRemove(format)} className="text-red-500 hover:text-red-400"><ICONS.Delete/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        
        const DashboardFoldersPage = ({ folders, roles, openModal }) => {
            const handleFolderDelete = (folder) => {
                openModal('confirm_password_delete', { 
                    itemType: 'admin_folder', 
                    itemId: folder.id,
                    itemName: folder.name
                });
            };
            return (
                 <div>
                    <h2 className="text-3xl font-bold mb-6">All Folders</h2>
                     <div className="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-gray-800 text-sm text-left text-gray-300">
                                <thead className="bg-gray-700 text-xs uppercase">
                                    <tr>
                                        <th scope="col" className="px-6 py-3">Name</th>
                                        <th scope="col" className="px-6 py-3">Owner</th>
                                        <th scope="col" className="px-6 py-3">Created Date</th>
                                        <th scope="col" className="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {folders.map(folder => (
                                        <tr key={folder.id} className="border-b border-gray-700 hover:bg-gray-700/50">
                                            <td className="px-6 py-4 font-medium text-white">{folder.name}</td>
                                            <td className="px-6 py-4">{roles[folder.owner]?.name || 'Unknown'}</td>
                                            <td className="px-6 py-4">{folder.createdAt ? new Date(folder.createdAt).toLocaleDateString() : 'N/A'}</td>
                                            <td className="px-6 py-4 text-center">
                                                <button onClick={() => handleFolderDelete(folder)} title="Delete" className="text-red-500 hover:text-red-400"><ICONS.Delete /></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {folders.length === 0 && (
                                        <tr><td colSpan="4" className="text-center py-8 text-gray-500">No folders have been created.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const SettingsRolesPermissions = ({ roles, setRoles, showNotification, openModal }) => {
            const [editableRoles, setEditableRoles] = useState(JSON.parse(JSON.stringify(roles)));
            const [editingRole, setEditingRole] = useState(null);

             useEffect(() => {
                setEditableRoles(JSON.parse(JSON.stringify(roles)));
            }, [roles]);

            const handleFieldChange = (roleKey, field, value) => {
                setEditableRoles(prev => {
                    const newRole = { ...prev[roleKey] };
                    if (field === 'dashboardAccess') {
                        newRole[field] = value.split(',').map(s => s.trim()).filter(Boolean);
                    } else {
                        newRole[field] = value;
                    }
                    return {
                        ...prev,
                        [roleKey]: newRole
                    };
                });
            };

            const handleEdit = (roleKey) => setEditingRole(roleKey);
            const handleUpdate = (roleKey) => {
                setRoles(prev => ({ ...prev, [roleKey]: editableRoles[roleKey] }));
                setEditingRole(null);
                showNotification(`${roles[roleKey].name} role updated successfully.`, 'success');
            };
            const handleDeleteRole = (roleKey) => {
                if (['USER', 'MODERATOR', 'ADMIN'].includes(roleKey)) {
                    showNotification('Cannot delete default roles.', 'error');
                    return;
                }
                 openModal('confirm_password_delete', { 
                    itemType: 'role', 
                    itemId: roleKey,
                    itemName: roles[roleKey]?.name
                });
            };
            
            const renderField = (roleKey, field, label) => {
                const isEditing = editingRole === roleKey;
                const value = editableRoles[roleKey]?.[field] ?? '';
                const displayValue = Array.isArray(value) ? value.join(',') : String(value);

                return (
                    <div className="grid grid-cols-3 gap-4 items-center">
                        <label className="text-gray-400 font-semibold">{label}:</label>
                        <input
                            type="text"
                            value={displayValue}
                            onChange={(e) => handleFieldChange(roleKey, field, e.target.value)}
                            disabled={!isEditing}
                            className="col-span-2 bg-gray-600 border border-gray-500 rounded-md py-1 px-3 text-gray-200 disabled:bg-gray-700 disabled:text-gray-400"
                        />
                    </div>
                );
            };
            
            return(
                 <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-white">User Roles and Permissions</h3>
                        <AppButton onClick={() => openModal('add_role')} variant="create">Add Role</AppButton>
                    </div>
                    <div className="space-y-6">
                        {Object.entries(roles).map(([key, role]) => (
                            <div key={key} className="bg-gray-700 p-4 rounded-md">
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="font-bold text-lg text-blue-400">{role.name}</h4>
                                    <div className="flex gap-2">
                                        {editingRole === key ? (
                                             <AppButton onClick={() => handleUpdate(key)} variant="update">Update</AppButton>
                                        ) : (
                                             <AppButton onClick={() => handleEdit(key)} variant="edit">Edit</AppButton>
                                        )}
                                        {!['USER', 'MODERATOR', 'ADMIN'].includes(key) &&
                                          <AppButton onClick={() => handleDeleteRole(key)} variant="delete"><ICONS.Delete/></AppButton>
                                        }
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    {renderField(key, 'storageLimit', 'Storage Limit')}
                                    {renderField(key, 'folderLimit', 'Folder Limit')}
                                    {renderField(key, 'permissions', 'Permissions')}
                                    {renderField(key, 'dashboardAccess', 'Dashboard Access')}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };
        
        const SettingsSecurity = ({ showNotification, openModal, roles, systemBackups, setSystemBackups }) => {
            const createBackup = () => {
                const newBackup = {
                    id: generateId(),
                    name: `dashboard_backup_${new Date().toISOString().split('T')[0]}.json`,
                    date: new Date().toISOString(),
                    data: { roles } 
                };
                setSystemBackups(prev => [...prev, newBackup]);
                showNotification('New backup created successfully.', 'success');
            };

            const downloadBackup = (backup) => {
                 showNotification(`Downloading ${backup.name}...`, 'success');
                 const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup.data));
                 const downloadAnchorNode = document.createElement('a');
                 downloadAnchorNode.setAttribute("href", dataStr);
                 downloadAnchorNode.setAttribute("download", backup.name);
                 document.body.appendChild(downloadAnchorNode);
                 downloadAnchorNode.click();
                 downloadAnchorNode.remove();
            };

            const deleteBackup = (backup) => {
                 openModal('confirm_password_delete', { 
                    itemType: 'system_backup', 
                    itemId: backup.id,
                    itemName: backup.name
                });
            };

            return (
                <div className="bg-gray-800 p-6 rounded-lg shadow-lg space-y-8">
                     <div>
                        <h3 className="text-xl font-bold text-white mb-4">Dashboard Data Backup</h3>
                        <AppButton onClick={createBackup} variant="create">Create New Backup</AppButton>
                        <ul className="mt-4 space-y-2">
                            {systemBackups.map(b => (
                                <li key={b.id} className="flex justify-between items-center bg-gray-700 p-3 rounded-md">
                                    <span>{b.name} - {new Date(b.date).toLocaleDateString()}</span>
                                    <div className="flex gap-2">
                                        <AppButton onClick={() => downloadBackup(b)} variant="download"><ICONS.Download/></AppButton>
                                        <AppButton onClick={() => deleteBackup(b)} variant="delete"><ICONS.Delete/></AppButton>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    </div>
                    <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-red-500/50">
                        <h3 className="text-xl font-bold text-red-400 mb-4">Danger Zone</h3>
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="font-bold">Factory Reset</p>
                                <p className="text-sm text-gray-400">Erase all data and restore initial settings.</p>
                            </div>
                            <AppButton onClick={() => openModal('factory_reset')} variant="delete">Reset All Data</AppButton>
                        </div>
                    </div>
                </div>
            );
        };
        
        const SettingsMaintenance = ({ onSetMaintenance, showNotification }) => {
            const [html, setHtml] = useLocalStorage('maintenance_html', INITIAL_MAINTENANCE_HTML);
            const [css, setCss] = useLocalStorage('maintenance_css', INITIAL_MAINTENANCE_CSS);
            const [js, setJs] = useLocalStorage('maintenance_js', INITIAL_MAINTENANCE_JS);

            const [tempHtml, setTempHtml] = useState(html);
            const [tempCss, setTempCss] = useState(css);
            const [tempJs, setTempJs] = useState(js);
            
            const [activeEditor, setActiveEditor] = useState('html');

            const handleSave = () => {
                setHtml(tempHtml);
                setCss(tempCss);
                setJs(tempJs);
                showNotification('Maintenance page code updated.', 'success');
            };
            
            const handleRefresh = () => {
                setTempHtml(html);
                setTempCss(css);
                setTempJs(js);
                showNotification('Editors refreshed with saved code.', 'success');
            };

            const timeOptions = [
                { label: '5 minutes', value: 5 }, { label: '15 minutes', value: 15 }, { label: '30 minutes', value: 30 },
                { label: '1 hour', value: 60 }, { label: '24 hours', value: 1440 }
            ];
            
            return (
                 <div className="bg-gray-800 p-6 rounded-lg shadow-lg space-y-8">
                     <div>
                        <h3 className="text-xl font-bold text-white mb-4">Maintenance Mode Control</h3>
                        <p className="text-gray-400 mb-4">Enable or disable maintenance mode for a specified duration.</p>
                        <div className="flex flex-wrap gap-2">
                             {timeOptions.map(opt => (
                                <AppButton key={opt.value} onClick={() => onSetMaintenance(opt.value)} variant="enable">
                                    Enable {opt.label}
                                </AppButton>
                            ))}
                            <AppButton onClick={() => onSetMaintenance(0)} variant="disable">Disable Immediately</AppButton>
                        </div>
                    </div>
                    <div>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-white">Maintenance Page Code Editor</h3>
                             <div className="flex gap-2">
                                <AppButton onClick={handleRefresh} variant="refresh"><ICONS.Refresh/> Refresh</AppButton>
                                <AppButton onClick={handleSave} variant="save"><ICONS.Save/> Save All</AppButton>
                            </div>
                        </div>

                        <div className="border-b border-gray-700">
                             <nav className="-mb-px flex space-x-4">
                                <button onClick={() => setActiveEditor('html')} className={`py-2 px-3 font-medium text-sm rounded-t-md ${activeEditor === 'html' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}>HTML</button>
                                <button onClick={() => setActiveEditor('css')} className={`py-2 px-3 font-medium text-sm rounded-t-md ${activeEditor === 'css' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}>CSS</button>
                                <button onClick={() => setActiveEditor('js')} className={`py-2 px-3 font-medium text-sm rounded-t-md ${activeEditor === 'js' ? 'bg-gray-700 text-white' : 'text-gray-400 hover:bg-gray-700/50'}`}>JavaScript</button>
                            </nav>
                        </div>
                        <div className="bg-gray-700 p-2 rounded-b-lg">
                            {activeEditor === 'html' && <textarea value={tempHtml} onChange={(e) => setTempHtml(e.target.value)} rows="15" className="w-full bg-gray-900 border border-gray-600 rounded-md p-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none custom-scrollbar" placeholder="HTML content..."></textarea>}
                            {activeEditor === 'css' && <textarea value={tempCss} onChange={(e) => setTempCss(e.target.value)} rows="15" className="w-full bg-gray-900 border border-gray-600 rounded-md p-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none custom-scrollbar" placeholder="CSS styles..."></textarea>}
                            {activeEditor === 'js' && <textarea value={tempJs} onChange={(e) => setTempJs(e.target.value)} rows="15" className="w-full bg-gray-900 border border-gray-600 rounded-md p-4 text-gray-200 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none custom-scrollbar" placeholder="JavaScript code..."></textarea>}
                        </div>
                    </div>
                </div>
            );
        };
        
        const IntegrationCard = ({ title, children }) => (
            <div className="bg-gray-700 p-4 rounded-lg">
                <h4 className="text-lg font-bold text-blue-400 mb-3">{title}</h4>
                <div className="space-y-3">{children}</div>
            </div>
        );
        
        const APIEntry = ({ name, integrations, openModal }) => {
            const integration = integrations[name] || { enabled: false };
            const isEnabled = integration.enabled;
            const statusColor = isEnabled ? 'text-green-400' : 'text-yellow-400';
            const statusText = isEnabled ? 'Enabled' : 'Disabled';
            
            const serviceIconMap = {
                'AWS S3 API': 'AwsS3',
                'Firebase API': 'Firebase',
                'Dropbox API': 'Dropbox',
                'Google AI Studio': 'GoogleAi',
                'ChatGPT': 'ChatGpt',
                'Claude': 'Claude',
                'PostgreSQL API': 'PostgreSql',
                'MongoDB Atlas API': 'MongoDb',
                'Supabase API': 'Supabase',
                'n8n Webhook': 'N8n',
                'GitHub API': 'GitHub',
            };
            const iconKey = serviceIconMap[name];
            const IconComponent = iconKey ? ICONS[iconKey] : null;

            return (
                <div className="flex items-center justify-between bg-gray-800 p-2 rounded-md">
                    <div className="flex items-center gap-2">
                       {IconComponent && <span className="w-5 h-5 text-gray-300">{IconComponent({})}</span>}
                       <span className="text-gray-300">{name}</span>
                       <span className={`text-xs font-bold ${statusColor}`}>({statusText})</span>
                    </div>
                    <AppButton onClick={() => openModal('api_connect', { name })} variant="connect">Manage</AppButton>
                </div>
            );
        };

        const SettingsIntegration = ({ openModal, integrations }) => {
            return (
                <div className="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 className="text-xl font-bold text-white mb-4">API & Service Integrations</h3>
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">
                        <div className="space-y-6">
                            <IntegrationCard title="Storage & Authentication">
                                <APIEntry name="AWS S3 API" integrations={integrations} openModal={openModal} />
                                <APIEntry name="Firebase API" integrations={integrations} openModal={openModal} />
                                <APIEntry name="Dropbox API" integrations={integrations} openModal={openModal} />
                            </IntegrationCard>
                            <IntegrationCard title="DataBase">
                                <APIEntry name="PostgreSQL API" integrations={integrations} openModal={openModal} />
                                <APIEntry name="MongoDB Atlas API" integrations={integrations} openModal={openModal} />
                                <APIEntry name="Supabase API" integrations={integrations} openModal={openModal} />
                            </IntegrationCard>
                        </div>
                         <div className="space-y-6">
                            <IntegrationCard title="AI Agent Integration">
                                <APIEntry name="Google AI Studio" integrations={integrations} openModal={openModal} />
                                <APIEntry name="ChatGPT" integrations={integrations} openModal={openModal} />
                                <APIEntry name="Claude" integrations={integrations} openModal={openModal} />
                            </IntegrationCard>
                             <IntegrationCard title="Workflow & Code">
                                <APIEntry name="n8n Webhook" integrations={integrations} openModal={openModal} />
                                <APIEntry name="GitHub API" integrations={integrations} openModal={openModal} />
                            </IntegrationCard>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardSettingsPage = (props) => {
            const [activeTab, setActiveTab] = useState('permissions');
            const tabs = [
                { id: 'permissions', label: 'User Roles & Permissions'},
                { id: 'security', label: 'Security' },
                { id: 'maintenance', label: 'Maintenance' },
                { id: 'integration', label: 'Integration' }
            ];
            
            return (
                <div>
                    <h2 className="text-3xl font-bold mb-6">Settings</h2>
                    <div className="mb-6 border-b border-gray-700">
                        <nav className="-mb-px flex space-x-6 overflow-x-auto">
                            {tabs.map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                className={`whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors
                                ${activeTab === tab.id ? 'border-blue-500 text-blue-400' : 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500'}`}>
                                    {tab.label}
                                </button>
                            ))}
                        </nav>
                    </div>
                    {activeTab === 'permissions' && <SettingsRolesPermissions {...props} />}
                    {activeTab === 'security' && <SettingsSecurity {...props} />}
                    {activeTab === 'maintenance' && <SettingsMaintenance {...props} />}
                    {activeTab === 'integration' && <SettingsIntegration {...props} />}
                </div>
            );
        };

        const AdminDashboard = (props) => {
            const { currentUser, roles, onLogout } = props;
            const userRole = roles[currentUser];
            const [activePage, setActivePage] = useState(userRole.dashboardAccess[0] || 'panel');
            const [isMobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            const renderPage = () => {
                if (!userRole.dashboardAccess.includes(activePage)) {
                    const firstAccessiblePage = userRole.dashboardAccess[0] || 'panel';
                    if (activePage !== firstAccessiblePage) {
                        setActivePage(firstAccessiblePage);
                    }
                    return null;
                }
                switch (activePage) {
                    case 'panel': return <DashboardPanelPage {...props} />;
                    case 'content': return <DashboardContentPage {...props} />;
                    case 'files': return <DashboardFilesPage {...props} />;
                    case 'formats': return <DashboardFormatsPage {...props} />;
                    case 'folders': return <DashboardFoldersPage {...props} />;
                    case 'settings': return <DashboardSettingsPage {...props} />;
                    default: return <div className="text-center"><h2 className="text-2xl font-bold">Page not implemented</h2><p>{activePage}</p></div>;
                }
            };

            return (
                <div className="flex h-screen bg-gray-900 text-gray-200">
                    <AdminSidebar 
                        activePage={activePage} 
                        setActivePage={setActivePage} 
                        onLogout={onLogout} 
                        isMobileMenuOpen={isMobileMenuOpen} 
                        setMobileMenuOpen={setMobileMenuOpen} 
                        accessiblePages={userRole.dashboardAccess} 
                    />
                    <div className="flex-1 flex flex-col overflow-hidden">
                         <header className="lg:hidden bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-30">
                            <button onClick={() => setMobileMenuOpen(true)} className="text-white"><ICONS.Menu /></button>
                            <h1 className="text-xl font-bold text-white">Admin Panel</h1>
                            <div className="w-6">{/* spacer */}</div>
                        </header>
                        <main className="flex-1 p-4 md:p-8 overflow-y-auto custom-scrollbar">
                           {renderPage()}
                        </main>
                    </div>
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black opacity-50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
                </div>
            );
        };
        
        // --- Main App Component ---
        const App = () => {
            const [currentUser, setCurrentUser] = useLocalStorage('currentUser', null);
            const [roles, setRoles] = useLocalStorage('roles', INITIAL_ROLES);
            const [backups, setBackups] = useLocalStorage('backups', []);
            const [folders, setFolders] = useLocalStorage('folders', []);
            const [supportedFormats, setSupportedFormats] = useLocalStorage('supported_formats', INITIAL_SUPPORTED_FILE_FORMATS);
            const [integrations, setIntegrations] = useLocalStorage('integrations', {});
            const [systemBackups, setSystemBackups] = useLocalStorage('system_backups', []);
            const [maintenanceEndTime, setMaintenanceEndTime] = useLocalStorage('maintenanceEndTime', null);
            
            const [maintenanceHtml] = useLocalStorage('maintenance_html', INITIAL_MAINTENANCE_HTML);
            const [maintenanceCss] = useLocalStorage('maintenance_css', INITIAL_MAINTENANCE_CSS);
            const [maintenanceJs] = useLocalStorage('maintenance_js', INITIAL_MAINTENANCE_JS);
            
            const inactivityTimerRef = useRef(null);
            
            const [modal, setModal] = useState({ type: null, data: null, error: null });
            const [notification, setNotification] = useState({ show: false, message: '', type: 'success' });

            const isMaintenanceActive = useMemo(() => maintenanceEndTime && new Date().getTime() < maintenanceEndTime, [maintenanceEndTime]);
            const userRole = useMemo(() => currentUser ? roles[currentUser] : null, [currentUser, roles]);

            const showNotification = useCallback((message, type = 'success') => {
                setNotification({ show: true, message, type });
                setTimeout(() => setNotification(prev => ({ ...prev, show: false })), 4000);
            }, []);

            const handleLogout = useCallback(() => {
                if (currentUser) {
                    setCurrentUser(null);
                    showNotification("You have been logged out.", "success");
                    setModal({ type: null });
                }
            }, [currentUser, setCurrentUser, showNotification]);

            const resetInactivityTimer = useCallback(() => {
                if(inactivityTimerRef.current) clearTimeout(inactivityTimerRef.current);
                if (currentUser) {
                    inactivityTimerRef.current = setTimeout(handleLogout, INACTIVITY_TIMEOUT);
                }
            }, [currentUser, handleLogout]);

            useEffect(() => {
                const events = ['mousemove', 'keydown', 'click', 'scroll'];
                events.forEach(event => window.addEventListener(event, resetInactivityTimer));
                resetInactivityTimer();
                return () => {
                    events.forEach(event => window.removeEventListener(event, resetInactivityTimer));
                    if(inactivityTimerRef.current) clearTimeout(inactivityTimerRef.current);
                };
            }, [resetInactivityTimer]);
            
            useEffect(() => {
                const interval = setInterval(() => {
                    if (maintenanceEndTime && new Date().getTime() > maintenanceEndTime) {
                        setMaintenanceEndTime(null);
                        showNotification('Maintenance mode has ended.', 'success');
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [maintenanceEndTime, showNotification, setMaintenanceEndTime]);

            const handleLogin = (password) => {
                const passHash = hashString(password);
                const userRoleKey = Object.keys(roles).find(key => roles[key].passHash === passHash);
                if (userRoleKey) {
                    setCurrentUser(userRoleKey);
                    setModal({type: null});
                    showNotification(`Welcome, ${roles[userRoleKey].name}!`, 'success');
                } else {
                    setModal(prev => ({ ...prev, error: 'Invalid password.'}));
                }
            };
            
            const handleAction = useCallback((type, data) => {
                switch(type) {
                    case 'import_files':
                        const newBackups = data.map((file) => ({...file, id: generateId()}));
                        setBackups(prev => [...prev, ...newBackups]);
                        break;
                    case 'create_folder': 
                        if (!currentUser) return;
                        const newFolder = { id: generateId(), name: data.name, folderId: data.folderId, owner: currentUser, createdAt: new Date().toISOString() };
                        setFolders(prev => [...prev, newFolder]);
                        showNotification(`Folder '${data.name}' created.`, 'success');
                        break;
                }
            }, [currentUser, setBackups, setFolders, showNotification]);
            
            const handleIntegrationUpdate = (serviceName, apiKey, isEnabled) => {
                setIntegrations(prev => ({
                    ...prev,
                    [serviceName]: { apiKey, enabled: isEnabled }
                }));
            };

            const handlePasswordDelete = (password) => {
                if (hashString(password) !== DELETE_PASSWORD_HASH) {
                     setModal(prev => ({...prev, error: 'Incorrect deletion password!'})); return;
                }
                
                const { itemType, itemId, itemName } = modal.data;
                let successMessage = `'${itemName}' was successfully deleted.`;
                
                switch (itemType) {
                    case 'role': setRoles(prev => { const next = {...prev}; delete next[itemId]; return next; }); break;
                    case 'system_backup': setSystemBackups(prev => prev.filter(b => b.id !== itemId)); break;
                    case 'format': setSupportedFormats(prev => prev.filter(f => f !== itemId)); break;
                    case 'admin_file':
                    case 'user_file': 
                         setBackups(prev => prev.filter(b => b.id !== itemId)); 
                         break;
                    case 'user_folder':
                    case 'admin_folder':
                         const folderIdsToDelete = new Set([itemId]);
                         const findChildren = (parentId) => {
                            folders.forEach(f => {
                                if (f.folderId === parentId) {
                                    folderIdsToDelete.add(f.id);
                                    findChildren(f.id);
                                }
                            });
                         };
                         findChildren(itemId);
                         setFolders(prev => prev.filter(f => !folderIdsToDelete.has(f.id)));
                         setBackups(prev => prev.filter(b => b.folderId && !folderIdsToDelete.has(b.folderId)));
                         successMessage = `Folder '${itemName}' and all its contents were deleted.`;
                         break;
                    default: showNotification('An unknown error occurred.', 'error'); return;
                }
                
                showNotification(successMessage, 'success');
                setModal({ type: null });
            };

            const handleFactoryReset = (password) => {
                if (hashString(password) !== DELETE_PASSWORD_HASH) {
                     setModal(prev => ({...prev, error: 'Incorrect deletion password!'})); return;
                }

                setCurrentUser(null);
                setRoles(INITIAL_ROLES);
                setBackups([]);
                setFolders([]);
                setSupportedFormats(INITIAL_SUPPORTED_FILE_FORMATS);
                setIntegrations({});
                setSystemBackups([]);
                setMaintenanceEndTime(null);
                setMaintenanceHtml(INITIAL_MAINTENANCE_HTML);
                setMaintenanceCss(INITIAL_MAINTENANCE_CSS);
                setMaintenanceJs(INITIAL_MAINTENANCE_JS);

                showNotification('System has been reset to factory settings.', 'success');
                setModal({ type: null });
            };

            const handleSetMaintenance = (minutes) => {
                if (minutes > 0) {
                    const endTime = new Date().getTime() + minutes * 60 * 1000;
                    setMaintenanceEndTime(endTime);
                    showNotification(`Maintenance mode enabled for ${minutes} minutes.`, 'success');
                } else {
                    setMaintenanceEndTime(null);
                    showNotification('Maintenance mode disabled.', 'success');
                }
            };
            
            if (isMaintenanceActive && userRole?.name !== 'Administrator') {
                 const fullHtml = `<html><head><title>Maintenance</title><style>${maintenanceCss}</style></head><body>${maintenanceHtml}<script>${maintenanceJs}<\/script></body></html>`;
                 return <div dangerouslySetInnerHTML={{ __html: fullHtml }} />;
            }
            
            const renderContent = () => {
                if (currentUser && userRole && userRole.dashboardAccess && userRole.dashboardAccess.length > 0) {
                    return <AdminDashboard 
                                currentUser={currentUser} roles={roles} setRoles={setRoles}
                                onLogout={() => setModal({ type: 'confirm_logout' })} backups={backups}
                                folders={folders} supportedFormats={supportedFormats} setSupportedFormats={setSupportedFormats}
                                integrations={integrations} showNotification={showNotification}
                                onSetMaintenance={handleSetMaintenance} openModal={(type, data) => setModal({ type, data })}
                                systemBackups={systemBackups} setSystemBackups={setSystemBackups}
                            />;
                }
                return <UserFileDashboard 
                            currentUser={currentUser} roles={roles} backups={backups} folders={folders}
                            supportedFormats={supportedFormats} showNotification={showNotification}
                            openLoginModal={() => setModal({ type: 'login' })}
                            onLogout={() => setModal({ type: 'confirm_logout' })}
                            openModal={(type, data) => setModal({ type, data })}
                            onAction={handleAction}
                        />;
            };

            return (
                <React.Fragment>
                    {renderContent()}
                    
                    {modal.type === 'login' && <PasswordPromptModal action="login" error={modal.error} onClose={() => setModal({type: null})} onSubmit={handleLogin} title="Login" description="Please enter your password." confirmText="Login"/>}
                    {modal.type === 'confirm_logout' && <ConfirmActionModal title="Exit" message="Are you sure you want to log out?" onConfirm={handleLogout} onCancel={() => setModal({ type: null })} confirmVariant="exit" confirmText="Exit"/> }
                    {modal.type === 'confirm_password_delete' && <PasswordPromptModal action="delete" error={modal.error} onClose={() => setModal({ type: null })} onSubmit={handlePasswordDelete} title="Confirm Deletion" description={`To delete '${modal.data?.itemName}', please enter the deletion password.`} confirmText="Delete"/> }
                    {modal.type === 'factory_reset' && <PasswordPromptModal action="delete" error={modal.error} onClose={() => setModal({ type: null })} onSubmit={handleFactoryReset} title="Factory Reset Confirmation" description="This action is irreversible. To proceed, please enter the deletion password." confirmText="Reset All Data"/>}
                    {modal.type === 'api_connect' && modal.data && <IntegrationModal serviceName={modal.data.name} integration={integrations[modal.data.name]} onUpdate={handleIntegrationUpdate} onClose={() => setModal({type: null})} showNotification={showNotification} />}
                    {modal.type === 'add_role' && <AddRoleModal roles={roles} setRoles={setRoles} onClose={() => setModal({type: null})} showNotification={showNotification} />}

                    <Notification {...notification} />
                </React.Fragment>
            );
        };
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
